---
title: "30 Day Map Challenge"
author: "Iva Brunec"
date: "31 October 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

## Day 1: Points
A map with points. <br>
Philadelphia base map downloaded from: https://www.pasda.psu.edu/uci/DataSummary.aspx?dataset=7102 <br>
Philadelphia stree tree inventory downloaded from: https://www.opendataphilly.org/dataset/philadelphia-street-tree-inventory 

```{r day 1}
library(sf)
library(ggplot2)
library(dplyr)

phl_base <- read_sf("data/PhiladelphiaStreetCenterlines2020.shp") %>% 
  select(geometry) # only geometry

phl_trees <- st_read("data/69b39f50-460b-4b7b-b5ad-d8d9c491e4392020328-1-1vb911p.sd1c.shp")


ggplot() +
  geom_sf(data = phl_base$geometry, color = 'darkgrey', size = .25) +
  geom_sf(data = phl_trees, size=.05, color='#235347') +
  coord_sf() +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

```


## Day 2: Lines
A map with lines. <br>
Philadelphia High Injury Network downloaded from: https://www.opendataphilly.org/dataset/high-injury-network <br>
Philadelphia bike network downloaded from: https://www.opendataphilly.org/dataset/bike-network 

```{r day 2}
library(sf)
library(ggplot2)
library(dplyr)

phl_base <- read_sf("data/PhiladelphiaStreetCenterlines2020.shp") %>% 
  select(geometry) # only geometry

phl_hin <- st_read("data/high_injury_network_2020.shp")

phl_bike <- st_read("data/Bike_Network.shp")


ggplot() +
  geom_sf(data = phl_base$geometry, color = 'darkgrey', size = .25, alpha = .3) +
  geom_sf(data = phl_hin, size=.5, color='darkorange2', alpha = .5) +
  geom_sf(data = phl_bike, color = 'cyan4', size = .5, alpha = .5) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = 'black'))


```

## Day 3: Polygons
A map with polygons. <br>
Data from: https://www.statista.com/statistics/444589/european-beer-consumption-per-capita-by-country/ and https://en.wikipedia.org/wiki/List_of_countries_by_beer_consumption_per_capita. For wine: https://ourworldindata.org/grapher/wine-consumption-per-person but this contains data from 2014.

```{r day 3}
library(ggplot2)
library(grid)
library(maps)
library(mapdata)
library(ggmap)
library(mapproj)
library(cowplot)
library(dplyr)

world <- map_data("world")


europe_list <- c("Albania","Austria","Belarus","Belgium","Bosnia and Herzegovina","Bulgaria","Croatia","Cyprus",
                   "Czech Republic","Denmark","Estonia","Finland","France",
                   "Germany","Greece","Hungary","Iceland","Ireland","Italy","Latvia", "Kosovo",
                   "Lithuania","Luxembourg","Malta","Moldova","Montenegro", "Netherlands",
                 "Macedonia","Norway","Poland",
                   "Portugal","Romania","Russia","Serbia", "Slovakia","Slovenia","Spain",
                   "Sweden","Switzerland", "Turkey", "UK","Ukraine")

# filter out european countries
europe <- filter(world, region %in% europe_list) 

# read in beer data
beer_data <- read.table("data/europe_beer.csv", header=T, sep=",")

europe$beer_per_capita <- beer_data$beer_per_capita[match(europe$region,beer_data$region)]
europe$wine_per_capita <- beer_data$wine_per_capita[match(europe$region,beer_data$region)]
europe$spirits_per_capita <- beer_data$spirits_per_capita[match(europe$region,beer_data$region)]
europe$group <- as.factor(europe$group)
europe$region <- as.factor(europe$region)

beerplot <- ggplot(data = europe) + 
  geom_polygon(aes(x = long, y = lat, group = group, fill=beer_per_capita), color = 'white', size = .5) + 
  coord_fixed(1.3) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(), legend.position="bottom",
        legend.key.height = unit(.25, 'cm')) +
  coord_map(xlim = c(-17, 38),  ylim = c(32, 71)) +
  scale_fill_gradient(name = "", low = "#ee9b00", high = "#691e06", na.value = "grey50", limits = c(0,7)) 

wineplot <- ggplot(data = europe) + 
  geom_polygon(aes(x = long, y = lat, group = group, fill=wine_per_capita), color = 'white', size = .5) + 
  coord_fixed(1.3) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(), legend.position="bottom",
        legend.key.height = unit(.25, 'cm')) +
  coord_map(xlim = c(-17, 38),  ylim = c(32, 71)) +
  scale_fill_gradient(name = "", low = "#d62828", high = "#3f220f", na.value = "grey50", limits = c(0,7)) 

spiritplot <- ggplot(data = europe) + 
  geom_polygon(aes(x = long, y = lat, group = group, fill=spirits_per_capita), color = 'white', size = .5) + 
  coord_fixed(1.3) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(), legend.position="bottom",
        legend.key.height = unit(.25, 'cm')) +
  coord_map(xlim = c(-17, 38),  ylim = c(32, 71)) +
  scale_fill_gradient(name = "", low = "#63DDDD", high = "#001845", na.value = "grey50", limits = c(0,7)) 



plot_grid(wineplot, beerplot, spiritplot, nrow = 1)



```


## Day 4: hexagons
A map with hexagons. 
Cardinal sightings Oct-Dec 2020. Data from: https://www.gbif.org/occurrence/download/0042864-210914110416597 

```{r day 4}
library(ggplot2)
library(grid)
library(maps)
library(mapdata)
library(ggmap)
library(mapproj)
library(dplyr)


cardinals <- read.table("data/cardinals_2020.csv", fill=T, sep="\t", quote="", header=T)
cardinals_filtered <- filter(cardinals, decimalLongitude > -125 & decimalLongitude < -50)
usa <- map_data('usa')

ggplot() +
  geom_polygon(data = usa, aes(x=long, y = lat, group = group ), fill= 'grey80') + 
  geom_hex(data = cardinals_filtered, aes(x = decimalLongitude, y = decimalLatitude, fill= stat(log(count))), binwidth = c(.6,.5)) +
  coord_fixed(1.3) +
  scale_fill_gradientn(colors=c("paleturquoise4", "#D5BB9F", "#C42E2A"))+
  theme_minimal() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
         axis.title.x=element_blank(),
         axis.text.x=element_blank(),
         axis.ticks.x=element_blank(),
         axis.title.y=element_blank(),
         axis.text.y=element_blank(),
         axis.ticks.y=element_blank(), legend.position="")
```

## Day 5: Open Street Map data.
Attempting to read in GPS traces. <br>
This mostly failed (only got a few traces per query), so I plotted paths in Shenandoah by elevation.

```{r day 5}
library(ggplot2)
library(dplyr)
library(sf)

## attempt at downloading gps traces
# u <- "https://api.openstreetmap.org/api/0.6/trackpoints?bbox=-0.15,51.45,-0.12,51.51&page=0"
# download.file(url = u, destfile = "trace.gpx")
# #st_layers("trace.gpx")
# 
# r = st_read("trace.gpx", layer = "tracks")
# #st_geometry_type(r)
# 
# #plot(r$geometry)
# 
# ldn_base <- read_sf("data/statistical-gis-boundaries-london/ESRI/LSOA_2004_London_Low_Resolution.shp") %>% 
#   select(geometry) # only geometry
# 
# #ldn <- read_sf("data/statistical-gis-boundaries-london/ESRI/LSOA_2004_London_Low_Resolution.shp")  
# 
# #ldn_roads <- read_sf("data/OS VectorMap District (ESRI Shape File) TQ/data/TQ_Road.shp")
# 
# ggplot() +
#   geom_sf(data = ldn_base$geometry, color = 'darkgrey', size = .25) +
#   geom_sf(data = r$geometry, color = 'black', size= .5)+
#   theme_minimal() +
#   theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 

# let's try downloading shenandoah
library(osmdata)
library(ggmap)
library(elevatr)

q <- opq(bbox = c(-78.6035, 38.3309, -78.1329, 38.9380)) %>%
  add_osm_feature(key = 'highway', value = 'footway') %>%
  #add_osm_feature(key = 'highway', value = 'path') %>%
    osmdata_sf ()

geom <- as.data.frame(q$osm_points$geometry)
# split into two columns
library(tidyr)
geom <- geom %>%
     separate(geometry, into = c('lat', 'lon'), sep=",")

geom$lat <- sub('.', '', geom$lat)
geom$lat <- sub('.', '', geom$lat)
geom$lon <- gsub('^.|.$', '', geom$lon)

geom$lat <- as.numeric(geom$lat)
geom$lon <- as.numeric(geom$lon)

prj_dd <- "EPSG:4326"
df_elev_epqs <- get_elev_point(geom, prj = prj_dd, src = "epqs")
elev_data <- data.frame(df_elev_epqs)

#fway_shen <- osmdata_sp(q)
#sp::plot(fway_shen$osm_lines)
myLocation <- c(-78.6035, 38.3309, -78.1329, 38.9380)

mad_map <- get_map(location=myLocation, source='stamen', maptype = 'terrain-background', color='bw', force=T)


ggmap(mad_map,darken = c(0.2, "lightgrey"))+
  geom_point(data = elev_data,
          aes(x = coords.x1, y = coords.x2, color=elevation),
          alpha = .8,
          size = 1.2 )+
  scale_color_gradientn(colors=c("#72efdd", "#7400b8"),name="")+
  labs(x = "", y = "") +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
         axis.title.x=element_blank(),
         axis.text.x=element_blank(),
         axis.ticks.x=element_blank(),
         axis.title.y=element_blank(),
         axis.text.y=element_blank(),
         axis.ticks.y=element_blank(), legend.position="bottom",
        legend.key.height = unit(.25, 'cm'))

#### trying something out
library(elevatr)
library(raster)
library(sf)
library(USAboundaries)

counties <- us_counties(map_date = "1930-01-01", resolution = "high", states = c("NY"))

counties_sf <- as(counties, "Spatial")
elevation_data <-get_elev_raster(counties_sf, z=9, src = "aws")
map <- extract(elevation_data, counties)
plot(elevation_data, axes=TRUE)



```

## Day 6: Red.
A map with red colour or a map about something red. <br>
Wildfires in the US. Data from https://nifc.maps.arcgis.com/home/index.html 

```{r day 6}
# wildfire data
library(sf)
library(ggplot2)
library(dplyr)
library(maps)
library(mapdata)
library(mapproj)

wildfires <- st_read("data/AgencyHistoricFirePerimeters_2010_2019.shp")
wildfires_2020 <- st_read("data/AgecnyHistoricFirePerimeters_2020.shp")

wildfires <- rbind(wildfires, wildfires_2020); rm(wildfires_2020)
#wildfires$year <- as.numeric(as.character(wildfires$FIRE_YEAR))

### my laptop can't handle gganimate with geom data so we'll make separate tiff files and combine them later
fire_list <- split(wildfires, f = wildfires$FIRE_YEAR)

usa <- map_data('state')

year=2010

for (i in fire_list){
  ggplot() +
  geom_polygon(data = usa, aes(x=long, y = lat, group = group ), color='white', fill= 'grey80') + 
  geom_sf(data = i$geometry, color='firebrick3', alpha = .4) +
  coord_sf(xlim = c(-130,-70), ylim = c(25, 50)) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
         axis.title.x=element_blank(),
         axis.text.x=element_blank(),
         axis.ticks.x=element_blank(),
         axis.title.y=element_blank(),
         axis.text.y=element_blank(),
         axis.ticks.y=element_blank()) +
    ggtitle(paste0(year))
  
  filename <- paste0(year, ".tiff")
  ggsave(filename, width=6, height=4)
  
  year=year+1
  
}

acre_data <- wildfires[c('GIS_ACRES','FIRE_YEAR')]
acre_data <- st_set_geometry(acre_data, NULL) # remove geometry, coerce to data.frame

acre_sum <- acre_data %>%
  group_by(FIRE_YEAR) %>%
  summarise(total_acres = sum(GIS_ACRES, na.rm=T))

acre_sum <- na.omit(acre_sum)
ggplot(data = acre_sum, aes(x=FIRE_YEAR, y=total_acres)) +
  geom_bar(stat='identity')

```


## Day 7: Green.
A map with green colour or a map about something green. <br>
Forest coverage as & of land area. Data from https://ourworldindata.org/forest-area 
Loss of forest per year, in ha (I calculated it as a % of total area for each country): https://www.globalforestwatch.org/

```{r day 7}
library(ggplot2)
library(maps)
library(mapdata)
library(ggmap)
library(mapproj)
library(dplyr)
library(cowplot)

world <- map_data("world")

forest_cover <- read.table("data/forest-area-as-share-of-land-area.csv", header = T, sep=",")
forest_cover_filtered <- filter(forest_cover, Year < 2021 & Year > 2009)
forest_cover_filtered <- forest_cover_filtered %>%
  dplyr::rename(region = Entity)

## rename countries to match
levels(forest_cover_filtered$region) <- c(levels(forest_cover_filtered$region), "USA")
forest_cover_filtered$region[forest_cover_filtered$region == 'United States'] <- 'USA'

levels(forest_cover_filtered$region) <- c(levels(forest_cover_filtered$region), "UK")
forest_cover_filtered$region[forest_cover_filtered$region == 'United Kingdom'] <- 'UK'

levels(forest_cover_filtered$region) <- c(levels(forest_cover_filtered$region), "Czech Republic")
forest_cover_filtered$region[forest_cover_filtered$region == 'Czechia'] <- 'Czech Republic'

levels(forest_cover_filtered$region) <- c(levels(forest_cover_filtered$region), "Democratic Republic of the Congo")
forest_cover_filtered$region[forest_cover_filtered$region == 'Democratic Republic of Congo'] <- 'Democratic Republic of the Congo'



## now read in year-by-year loss
tree_cover_loss <-read.table("data/treecover_loss_by_region__ha.csv", header=T, sep=",")
tree_cover_loss$region <- as.character(tree_cover_loss$region)
tree_cover_loss_filtered <- filter(tree_cover_loss, umd_tree_cover_loss__year > 2009 & umd_tree_cover_loss__year < 2021)

world2 <- map_data("world")

## rename countries to match
levels(tree_cover_loss_filtered$region) <- c(levels(tree_cover_loss_filtered$region), "USA")
tree_cover_loss_filtered$region[tree_cover_loss_filtered$region == 'United States'] <- 'USA'

levels(tree_cover_loss_filtered$region) <- c(levels(tree_cover_loss_filtered$region), "UK")
tree_cover_loss_filtered$region[tree_cover_loss_filtered$region == 'United Kingdom'] <- 'UK'

levels(tree_cover_loss_filtered$region) <- c(levels(tree_cover_loss_filtered$region), "Czech Republic")
tree_cover_loss_filtered$region[tree_cover_loss_filtered$region == 'Czechia'] <- 'Czech Republic'

levels(tree_cover_loss_filtered$region) <- c(levels(tree_cover_loss_filtered$region), "Democratic Republic of the Congo")
tree_cover_loss_filtered$region[tree_cover_loss_filtered$region == 'Democratic Republic of Congo'] <- 'Democratic Republic of the Congo'

## plot year by year

year_current = 2020

forest_cover_current <- filter(forest_cover_filtered, Year == year_current)

world$forest_cover <- forest_cover_current$Forest.cover[match(world$region,forest_cover_current$region)]

ggplot(data = world) + 
  geom_polygon(aes(x = long, y = lat, group = group, fill=forest_cover), color = 'white', size = .2) + 
  coord_fixed(1.3) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(), legend.position="bottom",
        legend.key.height = unit(.15, 'cm'),
        legend.key.width = unit(.4, 'cm'),
        legend.title=element_text(size=8),
        legend.text=element_text(size=8),
        plot.title = element_text(size=12),
        legend.box.margin=margin(-10,-10,-10,-10)) +
  scale_fill_gradientn(colors=c("#d8f3dc", "#99e2b4", "#248277", "#025353"),na.value='lightgrey', name='') +
  ggtitle(paste0('% forest cover ',year_current))

plot_title <- paste0(year_current,"_forest_coverage.png")
ggsave(plot_title,width=6,height=5)



## plot year by year

for (year_current in c(2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020)){
  
tree_cover_loss_current <- filter(tree_cover_loss_filtered, umd_tree_cover_loss__year == year_current)

world2$percentage_adjusted <- tree_cover_loss_current$percentage_adjusted[match(world2$region,tree_cover_loss_current$region)]


ggplot(data = world2) + 
  geom_polygon(aes(x = long, y = lat, group = group, fill=percentage_adjusted), color = 'white', size = .2) + 
  coord_fixed(1.3) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(), legend.position="bottom",
        legend.key.height = unit(.15, 'cm'), 
        legend.key.width = unit(.4, 'cm'),
        legend.title=element_text(size=8),
        legend.text=element_text(size=8),
        plot.title = element_text(size=10)) +
#  scale_fill_gradientn(colors=c("#f2e9e4", "#9a8c98", "#4a4e69", "#22223b"),na.value='lightgrey', name='', limits = c(0,3.2)) +
    scale_fill_gradientn(colors=c("#d8f3dc", "#248277", "#025353"),na.value='lightgrey', name='', limits=c(0,3.2)) +
  ggtitle(paste0('% tree cover loss ', year_current))

plot_title <- paste0(year_current,".png")
ggsave(plot_title,width=8,height=4,dpi=300)

}

```
